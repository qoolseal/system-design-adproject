## Работа с требованиями системы
### Согласованность
- **Источник истины — PostgreSQL.** Все изменения фиксируются транзакциями (ACID), уникальные ограничения и внешние ключи защищают инварианты.
- **Кэш и поиск — «ускорители».** Redis и Elasticsearch держат производные данные и **допускают eventual consistency** (небольшую задержку обновления).
- **Событийная модель.** После фиксации в БД изменение попадает в таблицу `outbox`, затем в Kafka, а оттуда — в потребители: обновление кэша и индекса поиска.
- **Идемпотентность.** Повторные события обрабатываются без дублирования (идемпотентные ключи/версии объектов).
- **Границы согласованности.** Платежи/создание заказов — строго согласованные (CP); поиск/каталоги — допускают небольшое отставание (AP).

### Доступность
- **Один ЦОД в Москве, несколько зон.** PostgreSQL, Kafka, Redis, Elasticsearch разнесены по зонам: отказ одной зоны не останавливает систему.
- **Автоперезапуск и самовосстановление.** Kubernetes перезапускает поды; Patroni переключает ведущий в кластере БД; у Kafka — репликация и кворум брокеров.
- **Деградация без остановки.** Если Redis недоступен — читаем напрямую из БД/ES; если ES перегружен — отвечаем «упрощённым» набором полей или старым кэшем.
- **CDN для статики/медиа.** Даже при частичных сбоях серверов пользователи получают картинки и фронтовую статику.

### Производительность
- **Где что исполняем.** Пишем — в PostgreSQL; ищем и фильтруем — в Elasticsearch; тяжёлую аналитику — в ClickHouse; «горячие» данные — в Redis.
- **Оптимизация БД.** Индексы под частые запросы, партиционирование больших таблиц, пул соединений (pgbouncer), анализ `EXPLAIN ANALYZE`.
- **Асинхронные цепочки.** Долгие операции — через очередь событий; фронту возвращаем результат быстро, обработку продолжаем в фоне.
- **Ограничение нагрузки.** Таймауты, ретраи с «джиттером», ограничение RPS и пула соединений к БД, плавная деградация.

## Как держим пики нагрузки (примерные сценарии)
### 1. Всплеск чтения (много просмотров объявлений)
**Ситуация:**  
Например, вечером в пятницу на сайт заходит в 10 раз больше пользователей, чем обычно. Они в основном смотрят ленту и карточки объявлений.

**Что будет:**
- Пользователи активно грузят списки и карточки → основной поток обращений — на чтение.
- База данных PostgreSQL могла бы «захлебнуться», если бы к ней ходили напрямую.

**Что делает система:**
- **Redis** уже содержит «горячие» карточки и списки. Если данные есть в кэше → ответ отдаётся за миллисекунды.
- **Elasticsearch** обслуживает поисковые запросы (фильтры, сортировки), чтобы не нагружать PostgreSQL.
- **CDN** раздаёт картинки и фронтенд-статику без участия серверов.
- **Автоскейлер Kubernetes** поднимает больше pod’ов чтения (search-service, ad-service), чтобы распределить нагрузку.

**Для пользователя:** сайт остаётся быстрым, хотя в бекенде нагрузка выросла в разы.
### 2. Всплеск записи (массовые изменения/акции)

**Ситуация:**  
Компания запустила акцию, пользователи массово подают объявления. В секунду приходит не 100, а 2000 запросов на создание объявлений.

**Что будет:**
- Основная нагрузка — на запись в PostgreSQL (новые объявления и заказы).
- Если все пойдут напрямую, база может начать отклонять соединения.

**Что делает система:**
- **Ограничение RPS**: фронтовые сервисы выставляют лимиты на записи, чтобы база не падала; при превышении выдаём «429 — попробуйте позже».
- **Kafka и outbox**: запросы сначала пишутся в «журнал событий», подтверждаются пользователю (данные сохранены), а «тяжёлая обработка» (обновление поиска, аналитика) идёт асинхронно.
- **Приоритеты:** транзакции (оплаты, заказы) идут сразу в базу, фоновые операции (обновления счётчиков просмотров, логирование) могут откладываться.

**Для пользователя:** объявление или заказ сохраняются, иногда с задержкой появляются в поиске, но сайт не «лежит».
### 3. Пиковые кампании (праздники, маркетинговые акции)

**Ситуация:**  
Перед Новым годом или «Чёрной пятницей» ожидается резкий наплыв. В течение пары часов онлайн увеличивается в 5–10 раз.

**Что будет:**
- Одновременно много просмотров и много записей.
- Система должна выдержать без массовых ошибок.

**Что делает система заранее:**
- **Прогрев кэша**: популярные списки и карточки заранее кладём в Redis, чтобы их не строить заново.
- **Увеличение ресурсов**: заранее масштабируем pod’ы и реплики БД «вширь».
- **Упрощённый поиск**: при перегрузке можем отключить «дорогие» сортировки или фильтры (например, «сортировать по рейтингу продавца»), чтобы отвечать быстрее.
- **Резервные очереди**: часть фоновых задач (например, аналитика) временно откладывается, приоритет остаётся за заказами и оплатами.

**Для пользователя:** сайт остаётся доступным, но отдельные функции (например, сортировка по редким параметрам) могут работать чуть менее точно