## Сервис объявлений с доставкой и проведением оплаты
Схемы draw.io:
- [версия № 1](https://viewer.diagrams.net/?tags=%7B%7D&lightbox=1&target=blank&highlight=0000ff&edit=_blank&layers=1&nav=1&title=%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0%20%D0%BE%D0%B1%D1%8A%D1%8F%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B9%20%D1%81%20%D0%B4%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BA%D0%BE%D0%B9%20%D0%B8%20%D0%BE%D0%BF%D0%BB%D0%B0%D1%82%D0%BE%D0%B9&dark=auto#R%3Cmxfile%3E%3Cdiagram%20name%3D%22%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%E2%80%94%201%22%20id%3D%22m1w7S_AMzuUM7NPfwQDJ%22%3E3V1bk6O2Ev41rsp5mCnul0dfN6nsZqfOViqPKdlobDJguQDPjPPrIwyShYQB74wE5sU2ciNk9e1Td0uemPP4%2FUsCDrtvKIDRxNCC94m5mBiGbhomfstbTkWL61lFwzYJg5Lo0vAj%2FBeWjVrZegwDmFYIM4SiLDxUGzdov4ebrNIGkgS9VcmeUVR96gFsodDwYwMisfWvMMh2RatnuJf2X2G43ZEn645ffBMDQlz%2BknQHAvTGNJnLiTlPEMqKT%2FH7HEb55JF5Ke5bXfmWDiyB%2B6zLDSt7ES%2B%2Bp86vp9W36eLFe1n8uXmwSm68guhY%2FuLfwfMLKIecncg8pG9hHIE9vpq97cIM%2FjiATf7VG2Y7bttlcYSvdPxRHFc51FeYZPCdaSrH%2BQWiGGbJCZOU39paOWel0Hi2XVy%2FXVjgeCXNjpl%2Bg9wISrZvad%2BXmcEfysm5ZaJsYaJAkD7CV%2FwrU3G2duCQf8SzAKIIRmibgBjPzQEmIR4PTPjvni5ftM3vc%2FgOiaLUz3czpztzQbcqTLA0gQe6UcMDRxoLfIEFKAlgMnIuOANjgy2ajAM4xTkHRs0I09UGxghRH7D3DfEvOo2aEbY1MEY4psCIPcrC53ADshDtHzcojsE%2BwOxwIjyWWRC%2B4o%2Fb%2FOMvk4U2ma3Or94Ez5tXvJrn1%2FNog4eJgcelnW1d%2BblUuPKKcP0hhclriNmDf33e4fT8ujy%2Fzs%2BvRfvi%2FGqdHzEjxMvyieV48GeNucVgOvTOtxSDpF%2FZpE%2FuiTPm2wX5mfjV%2Fx%2BZDTzlzISMU2SNqsRS8WREFoMehSJrCvMMA4x7y0uUZDu0RXsQLS%2BtswQd9wHMe9Xw1YXmK0KHcgL%2FgVl2KicUHDPUERmm6JhsYMNwCfIHyRY2cqagy39LI1sSGGHVfK1i%2FLpJLm99QiEe8sUVOFV%2BmgQdki6KgZZ3cayiw%2Fh57hFAfbE3002Gkqu6c4yjgsCc5TKL7VL0Faxh9ITSMLdQmGSNsgzFDME0Crf5FxnilAYdsyjcwzldcGmfA%2FoNzqybugj6TaX%2B9b50xOqoI44aHbF61hERpX5FIKhxwTOA17Ub7C66%2BaNkh%2BL1MVWyDjZNbg41USXqlsGeLJVw70slnI4q4alRCYeDAYbZTSWmSQJODNkhJ0ivP8d261Vv1ZGejOsiKcUIPlU%2F%2FXGKEolbSpclLkRmdpSlT4Mg%2Bkj5ZyjiH7%2BI7egeVdsCS4Ut0J2RCpMpRZhUy4CjqZABb6Qy4KsxKB7nEAzFeJumuUbGP9Kh9JgCh%2FVtT5JD4OTEspuNgWnqTfRyjIFhjVSYbEXGgI%2Bl%2BMNEF4bXTM%2F%2FDo5ekvCN1BMZqjwRxzTbHqbwEaW4Ru9fUSKpwlcykw3tPv2GG76ADIK3%2FGnTmhjWQ841TIHfojAOs3C%2FvRbOqr23miIqcj80F6VVMlKXFI7L0DtMBmt1%2B6PZTNWCPIimoJYkk4Rb5uQWi8la6cwtJpNR07rG9CrKKz%2BuZwmh7o4pTFdWYM%2B6M%2FTmdbR5liL0RsvabgztfVq0u5cV9OaYvJ7vzy8CkO7ohQLOyoFStzoh126MnbbS261Oy2qil%2BSEBiZNKZaGbJpXc%2BKGTQTSNNyQ5lUYqTMnzjCEzuGEQndbhIgTulvpDUOF0InlTAISKICHybzaDEShtSwWAxhWpHFVpaefdQZjuMztWrVmpQQ2IM7hwH6dHuohDTPMBdOZTWAOfaBGxlU8uYAw0%2FI5l7qa2vqZJpBVo7fnXH9V10CZ3d9gVYFsXQBJ%2B8dhEBRqDdPwX7A%2B95crdimbuHN7NrEX3atmiFEpK7XLLie0NqY7fHrQHnVsGCsiWl590I0%2FmNVeScKT9ICen1MoxYF7gvCD4FLPVSNmVJBYiTYYCdE%2FIGB5gdZ5paHN%2F%2F%2FnotqRqEfcEqAoERsk8Ha4mmajJqGutnbQvLNgA1mptLpKU1G0weV8oeo6E7uXlZMM5N2ZtZYc1t4c%2F%2FG5VbTTgmo4eqcNqhtWE72kNBjxhtwmB%2BoLauM%2FtwCZs%2FE2CJ6qlPJeq%2Fu95iNoPy5zy5T5zLbPyRPn5KE6E1LSqiEcBiZV7r0Lr1JXuajYq9xZQp1UXbR7FVeNV%2FG4bJzVMRv3aWbAEMzAMWWswBUToDGKalawIL%2BSqg3b0uDqjDElJqPwC4aGNRZFGNZiKGm0lmo7OzZfCCYvymcNVMPt%2BqRpjxp%2BZxlSUgrTruGKUqS%2BzgXiXDlZKo9HHSqKaYh4srGUcYqLPoyInOtVuezqKrg8sDCtAnaTzacDY7fTUkTDp5IdFUU0urgtkewb7BRY6r6SELEFJeNWBlycyL%2BOJzRmZyFtJ2uLGxYQpKthAgvXuOKFegMWuug6igoEJvg342fcL%2BbaYRL4hSTZDKsaY5UVVnFMIdvYdvAdbPPdapXNn2Ur3fZptDOufd%2FnzYzUdd7Pd%2BWkvM06vZToV9zDBzyC3xUADMIhWHzZvM8dxsLRG830khyCmGFj96k3eAUYgxB3v0pjPAerwzHdVQNHP7EH%2FIYcVt%2FlOU7v8Zx7g%2B%2F0qKbWmkQ5OyRaq6tdTW08hwrhRfVSCJLNrhGKUYe7FHzldMKHcOuiL52iPoPUQd5A2r1HXAwRTi8jkGbhpuBkAwc5XNulPMC7goZZbE2BFhuKl1tOQKDY5hSFWB4Ss10Y1oXkfF3TBrB52Z7l6XtxlEDZnpaAzJYjQW5XKy4NkBm9rNelF0%2BRTQ3txl5R8F7XuOW5oTh6b96bu%2B7KQVORu%2FavFKypYiBxImoZWAmmfdI6qjNryWliPS%2BkdI3bn%2Ba2hNZ0vfkGSXuExCiJeApXU3DNYFyzy%2BxsoIVblHLGrLMc4tzFzHjDrgjtyilegwR%2BPr%2BPtX%2Fg5wq8JhGxRib9DEvGEPmiO497A1pmL%2Bb7A0a6a7DLlBPtqjGqHIKyDLUO2Lo3BNWVg5YiBCVgYFuXk9%2FWNX5Hi4rNAoYYyoxhEII258uVLdNVcENtG7vZkV1cs504Vzrxq1EaNuvBrf2XA3XHusZlqOhW8v5KX8RY2g%2FzWvSFC4dwsRaD4diymtC8Jik0wEZjJz65cWwRFMELmJ7Ie1%2BpYxdjcE8ozbYJrDtclyDyv4P1%2BJjj82fK1oS3lJ4NaIpLogbekCPDR8kbjw9eOzU2U1PKHHEN08CcvNR0pJzhtMaqWas4ShkjApkGxhT%2FdzBKzgj7ePo%2B69QSYUYDZ0CQ%2Fr0Oxs8WvQb%2BKVUYS4QA88UfwhTjnsJDmq8K6WRH6Biowcw6Xy7eey2Q1cvJvTJKRa2uAW1JB%2B%2FdvEuNkwW35cgr%2Fnw2V8WRV1Yvu1Bl5Ds6i4ekc%2F0%2BKh6e1iweptdIL6nQvJdKQini0bmscBhHt%2FLHxbgte1xdp5Feknj0EqztVzyG4Vxc%2Fo%2Fy2rZAW430ksSjlz%2Bb6VU8JJ3z%2BVHr4bXsePf9RnpJ4tELNJUhHmRz0r1YD58rivWMG62HikyP3Qs0lbFy6S4ecv5DQrp48NbjRnqrBfryp55ZKqCvMxroa98ZthEy2IM0T04v2FeKeeosH8MwT4J8WC3oRrAfKtAN%2Bffe%2B5cPp%2FOW%2FGHYD4uvIdZa%2FAt%2FQ5u9sZrtkyR5ErOsxfaTxwTmuYR3Qdz6%2FQPVm4Pn%2FE6tuoSD4r%2F3HU3svPO2vIGcc2tw4Q27JXbO0ys5t5bk%2BhmN%2FIb2YYaS%2FBR%2Be1mTLHxK8qfu4BH%2Fdnx3fm7tlwQ8gz24NYF4XMNPzB0GIHn5jrsJs3wCtUfNrjYa59bPypJZ3Ak89C%2FsJGTJ8GWCUMZyHk%2FT7hsK8pNxl%2F8B%3C%2Fdiagram%3E%3C%2Fmxfile%3E)
- [версия №2](https://viewer.diagrams.net/?tags=%7B%7D&lightbox=1&target=blank&highlight=0000ff&edit=_blank&layers=1&nav=1&title=%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0%20%D0%BE%D0%B1%D1%8A%D1%8F%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B9%20%D1%81%20%D0%B4%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%BA%D0%BE%D0%B9%20%D0%B8%20%D0%BE%D0%BF%D0%BB%D0%B0%D1%82%D0%BE%D0%B9&dark=auto#R%3Cmxfile%3E%3Cdiagram%20name%3D%22%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%B8%D1%86%D0%B0%20%E2%80%94%201%22%20id%3D%22m1w7S_AMzuUM7NPfwQDJ%22%3E5V1Zc%2BOoFv41rup%2BSEpC%2B6PXnqnpnk5N7tS995FYxNZENi5JztK%2FftACRoAWJ1ri5KHdCgItfN9ZOBzQxJjvnr9F8LD9gX0UToDmP0%2BMxQQA4HmA%2FJeWvBQlpmXkJZso8PMy%2FVRwG%2FxCRaFWlB4DH8WlignGYRIcyoVrvN%2BjdVIqg1GEn8rV7nFYvusBbpBUcLuGoVz638BPtnmpC5xT%2BW8o2GzpnXXby8%2FsIK1cvEm8hT5%2B4oqM5cSYRxgn%2BdHueY7CtPdov%2BTtVhVn2YNFaJ%2B0abCyFrvFz9j%2B7WX1Y7p4cB8Wf6%2BvCjDi5IW%2BMPLJ%2Bxd%2F4ijZ4g3ew3B5Kp1F%2BLj3UXpVjfx1qvMd4wMp1EnhPyhJXgow4THBpGib7MLirPzkxcvE%2BBitUc3jUgbAaIOKplfrZXB3s7w5bJ1wvf9n%2Bv%2F%2F%2FUej9dJ34W5Q9Ms3hHcoiV5IhQiFMAkey1jDgjIbVo81vcEBeWSgFfx2CmgLchuWVb5C%2FpxFoxM05IB7ilNRBtgZ4BXP%2BwjDY%2FEG03WCIwlSwrxDenjchXkFY%2FaIoiQgLP8O71B4g%2BMgCfCeVLnDSYJ3XIVpGGzSE0mKLQ8iPiZhsEdzJndaHbLp5dBzLRbF2StD6FRQdOrTSfxolS0nebZWjV6p48%2FtZQoy180%2F8D4g%2FRjsNxNjOgF2SJ5h5geP5HCTHt5E6b236BhPUqEk3aIR%2FXgP95BWJk%2FC1a9EbH28SyXuaRsk6PYAM9l4Ipq2DMVdLpDf71gBXD9sMjH9maNUlPswevhJLhMkaedq15pVLgRZaa2ItgdSwFGn%2FcjhqAMFkG4HQCqVAhhP1wmKqFH51Sk1XvkpCWv2ouuYRaaW3BNw6k7Zqd9e%2B3jwKesZ%2FdgqXSvjZ2nt8JtGEXzhqh3SCvH591lV1L8yzNoG5CB%2FhG7ZJOn0xZ%2B3EsFO9NGbtXCFflSQpVJlms2mT6kyu7B9ym5ypG6S%2Bii1M4fKdy%2FccnhHq2vn9olkR1RmxFF0iicqqM48Ams8TcT3Wx1ijZ602dKY2EoN2L11Eb0%2BY1hX2vkAkNotIXWHgdTwBIcBtIP0XIMj2g9KnSqDI9bX3W7tjbLPvU%2FEL6qheyeYOPxuSbDOht%2F6ZwIVDAOqKQwzzJaGYGitYRn1bq3p1tbvR8vo9mdipNELIzsmUk9Au58JaG8Y1WMJ9gT0pHrEsLHpurWqRPSNhfr9MIzNWnwGhlGu9M0wKTbi9GTchPuYTr2xaqjfE8PMz8QwaxiG2YL7ZLjv030CVj0jLXHwaA3ByM9kVcFAVlVkpGW%2BT0aaYACGFeDwM7Y3v5OCbzBB8Cm9m2o68SpFgdQg%2F4XBLkjSeceKeURl2wmh5mye%2FZJjfeLmvy53bGS%2FIKvjZr8OV9%2Bm5eR4df6tp9nvMvtd0Bvlt2bls6xkTpuY9BQp1LkmRla%2BKp6t3WRqWUJbRfHbSmP72VBx%2BoyZ3KbYPnUWO49i0xE9R8ZjjKIr8u8xIL0jA8qBZmW%2FBscLXQJWyR2G8IwD3%2BB4t%2BDqrMo0IccmV5NRJq8vPJsnMXpR3OuCWGPaVllJeS1Z09uMkCWRJu3VaYayl6HpEb9OI6%2BlUfn35mVhZhoBUDHWvnBUsSr0hFYC%2FVQnJ5L3VUIwfgp2IUyTH2ZbHAW%2F8D6B4Tl4NszlVUMs48njpVmDzlaZEmLfMfQV4j2DpLfWKGorIFu8uzvGnQmHVdHplcIhDtc9ebbUVfR0F%2Fkl6ly69zxkpnOWTe4jdQsb%2FUdjqBw7U1CBQMCvI%2F%2FRFqMsYjplQ33bG2KE4knCvEN%2BAJuMtiXp0UVZ1zIjaVHby3uBuZXWpYvYFRfxThcpDng7bHKtliNa47MVjhjTN4a0xrVCyOcmBvvff6Ym9db4qqSDgOeUQ2PK%2BUwLrqZFHawqHjGHjLl6Hm14Xr7jSxgQnCOjw6THONecutUjMwyBGbalYIZuDWiM6OwIx4wDfNmR927SFToHvMMJrIw3o4Xspi3KY0jGLZtr7lV7%2Bkxj8ISbMnexPOBgQw02RBTeAlySkgFC5MscW8fQgSvHJBz53EBRGbN4FZWYxeBH%2BgKzAKdqasyXQD12zJfP6R3n53BKaHs5zDIdp2y%2BtAHTC%2BsykThmQb%2BdeuL1AvMtsrOAVyLMxGXBh2b6eBmZtflffy%2FKF1pJd9UkfXZRZBCzs3SVxRqUDEAOLfgoJAOH6KUdJwAHs8OFExktWM0Zp2FsShRZtGtCkYI6ml4eASwxr3ZIAqhzsuVIxQ2Ok02EYgXwX3YwTlD09V16mK%2BJHFm1cNniaFOhu7Uhox1AHnrECEbrba2wMlW6LCntXIZEF0AV7G0VZL4cKaTzmlJGwHjunhxi2OMkuA%2FWMF0jWIMu2sGAXH4V74i8rg7HeFv25ZhHzytVpm%2BVJvnS4NTF7EV7bDiBPA5chkRzButcWmukVBiQ8ZMofAhnysmwK7XibeWC%2FrKoPXPXX%2BGuncGNSw8v6K5ZopXTNvDUn%2FYHUidfYKy77YpK0E%2BqqZzpZ5Zxdluu0etqVRwYZTsAH8Zbtsgu%2FeMGJsSz22clQAMM%2BNplmG2ZoH7x1hsLdLK49uw1lV55DsTpOFeltk84y%2FEX8gOVLx6hTbp9ANDWMN6%2BS53cvUOuC%2BMny5V1sjekSjbl4dMf8P4Byj1%2FmhcfKxIl5F45Cq%2FXUnUeEBVid70nRx%2BgH1%2BjR1RIppK8pGtgGKIQbyKY7ppxQFFAngdF4rmb04mmTr8PnhHdCEcNQj387b2KsrEZPdBsyiOPLND8wVGw3xkMlqxHipmjjw2EAZx3BoQsDzQg%2BqGBEK2DO%2FYY2pbH0HxI5HqNdzu495VRSi48zEc7tPJgOhsQn4bCLMZcNf3F4s1vjK9oeeLcWQ7bRXMLlKnFeMRxCwzLLdnvyAMz1xFK%2FeLnD4qD2wzEsLMPhsLsbQ4Yh5UAxAk6CP2eFr25u7sfq4ipaqogs2rywOgtfCRvLJMvhGiYpHvNlFwFelv0DDfpnnclAItShiHoQmbO3jrNEWZ7rlqLR38Bv1GWlscJjJJpuo0nKViHMI6DNS1eBeHbN5Skk87NIcCCsf0vERU0I2i5gq%2BzpeWyQaKiySbvZmKCjKdzYsoC%2FFnCYEmmq9M2%2BBmDSxRZC7w7kbVkJMeQ4dcLJ81hbN4hoJ%2FVteeGaS1BdK%2FshkWu9fX7Cevqclg3FTtpBU9ah63gWZTks2R82UBCmAHk5%2FXfGIB80556VyalEfV%2BbFkwLZX3Y3axJEeNgTygzDBoVJKZXlXmW8qJc43rM8tZnG1bqZM8GpuplhY2NqpLPGhsrFwY0diqIkm6sV1VqlrDoJrwOilTHhYbLofoPj0j7sO8C3w%2F18soDn4V%2ByqmmrlQTuSq1mxiLdIrEVUcn4xcnET4Ac1xmG4AvdjjTP7uiRMlFLWSuRrVUj3mK8fX9LYBNlaxezmU12PXZZxFiEgZ3oe5JTmEBJePk37WAJ4hJioN6N2on1dOHpbSy0xuJJj7o7nZcipiYSwdZUrd1lcsSeXjbtkAFmjFPJy2TKO2s%2BN7iNv2QRHBBTYUhlZXrX3tLaYzjsPbYz6DrnCd1W%2Buya5zjQp8g6f8NoBG2RfzogACo2SciPnGXW%2BSWtsnnzbjpEHB6mbZg1LZ4L5ywGu4qUouva1KLv2yO4ZJcLUOjx8re%2F9M96n1aov%2BsJND8MXSYZXj%2B8mcXWHbFZWk9ZXbVfNNiPE38eijr8vRGcWgsK9NPNQ9LQdNL2gasLGvGzu7t3lA9fOOsu8%2B2vt0TqmIeZCSYjpJm5w569TNt2EUu%2Fa9o%2FxjcQLZMesD2w31%2B%2FEeDSBJrhSjXki7WCy5YfuCm9ZaKXSrtMcYPxvmcrGG1y9KS9mUfZNNHRRcE2Yh%2FvttrwgLVmqXNt9qqZHi6gi8dq05gutKP8Dz2tlSWgXf38eon%2B9NjfjJhm50iivrlJrsnaF1iiGOMLWGLWHFBl7HO%2BqrveRRvvXTZKA6ZAkdwrVcAzU0S3RhmwK3YUq1oX4%2Fu3KZ8nTefPGnTJwwDA5xiiYbIIX46Lf1vd%2BUniDIDtuEd7TkBHP80GwroXnbJnnmQAsHXac8YGXZKH1vktegs8X6Vscby6tV2ijbeA%2Bps52W9OvmU5Jn62zRUDeQRKrf8MVI26ytfy6pyJ%2Bnj3Dn1U%2FfMjeW%2FwI%3D%3C%2Fdiagram%3E%3C%2Fmxfile%3E) 31.07.2025
### Анализ требований
Функциональные требования, вероятно предъявляемые заказчиком:
- Возможность добавления, редактирования, удаления объявлений их создателем
	- Реализация личного кабинета пользователя. Отображение истории заказов
- Загрузка фото (и видео)
- Интерфейс отображения объявлений, возможность фильтровать по типам, пагинация, поиск по ключевым словам
- Регистрация и авторизация пользователей. С помощью email + пароль, подтверждение через почту 
- Клиент может отправить заявку на покупку в объявлении, продавец её подтверждает, создаётся заказ
- Трекинг состояния заказа: создан, собирается, в доставке, прибыл, получен
	- Интеграция с сторонними API (если есть выбор доставки через Почту РФ, СДЭК, Boxberry)
	- Отправка уведомлений Email/SMS/push
- Проведение безопасной оплаты через сторонние сервисы, возвраты в случае отмены
- Модерация контента: 
	- премодерация: новые аккаунты пользователей и новые объявления попадают в состояние "На модерации". Там проходит проверку автоматически (на запрещённые слова) и ручную.
	- постмодерация: обработка жалоб
- Опционально: ведение рейтинга продавца и покупателя, отображение в профиле, возможность оставить отзыв на продавца/покупателя

Нефункциональные требования по пунктам:
- Производительность хотим < 300мс для поискового запроса, < 500мс для оформления заказа, 
- RPS до 1000 - ожидается в пиковые часы загрузки (18-21:00 по локальному времени), предполагаем 80% запросов на фильтр и поиск объявлений.
	- сервис поиска объявлений - 700 RPS, сервис объявлений (запросы на просмотр конкретных объявлений) - 200 RPS, запросы на оформление заказа и авторизацию - 100 RPS
- Масштабируемость: возможность выдерживать пиковые нагрузки, расчитываем на увеличение количества каталогов, фильтров, гео доставки, способов оплаты
- Отказоустойчивость: не падает при отказе стороннего API (retry, circuit breaker)
- SLA 99.9% доступность, 
  SLO 95% оформляются меньше чем за 1 с, 
  SLI: среднее время ответа, процент ошибок, доступность API
- Безопасность: хранение персональных данных в зашифрованном виде, защита от атак, защита от спама
- Наблюдаемость: централизованные логи (Loki, ELK), метрики и мониторинг через Prometheus + Grafana
- Данные: фиксируем статусы операций, реализуем сагу событий между микросервисами

#### Архитектурный стиль и паттерны
- Используем микросервисы + Kafka, так как заранее рассчитываем на масштабирование системы. Будет проще разносить микросервисы по нодам и дублировать их. Командам разработке проще работать в ограниченной зоне ответственности
- Микросервисы + event-driven архитектура. Для большей независимости сервисов друг от друга, уменьшение количества блокировок
- Шаблоны:
	- Saga pattern - у нас автономные сервисы, их необходимо связать сценариями. Попробуем реализовать хореографию через события, отправляемые в брокер. Учитываем необходимость компенсации, например, при отмене оплаты
	- CQRS используем только там, где это даёт прирост в производительности и масштабируемости - для разделения сервиса поиска по объявлениям (Elasticsearch лучше подходит для сложного поиска с множеством фильтров, будем настраивать индексы) и создания объявлений (это происходит реже, пишется сразу в Postgres)
		- Команды: Create / Update объявлений → в PostgreSQL (далее отправка событий в Kafka и асинхронное обновление elastic)
		- Запросы (Query): Поиск / фильтрация объявлений → в Elasticsearch (небольшая задержка, неконсистентность данных, после обновления - необходимый компромисс)
	- Outbox pattern - у нас будут распределённые транзакции, необходимо гарантировать доставку без потерь и сбоев, то есть консистентность данных. Реализуем через шину событий в Kafka
	- Circuit Breaker + Retry - шаблоны при работе с внешними API. Временных сбоев избежим с помощью повторных запросов, если дело плохо - избежим каскадного отказа с помощью Предохранителя.
### Масштабирование
Так как у нас микросервисная система с асинхронной коммуникацией через Kafka, то она может масштабироваться горизонтально. 
- Микросервисы stateless, используем балансировщик нагрузки для распределения запросов по инстансам микросервисов
- Elasticsearch можно масштабировать горизонтально, добавляя новые ноды. Использовать индексы по регионам
- Redis развёрнут в каждом регионе отдельно, масштабируем как кластер
- в Postgres используем read-реплики, шардирование по регионам, чтобы не подгружать дальние объявление
- При увеличении количества заказов увеличиваем количество партиций в Kafka. Топики по разбиты по смысловым доменам

CAP теорема: выбираем между согласованностью и доступностью
- согласованность важна для операций оплаты и создания заказа - они будут идти через синхронную запись в мастер-реплику
- доступность достигается за счёт дублирования сервисов и реплик на чтение
	- при разделении сети будут доступны записи из кэша, а новые записи буфферизируются в локальной outbox таблице
- **CP** для критичных операций (оплаты, создание заказа) и **AP** для сервисов поиска и отображения объявлений
#### Геораспределение
Для повышения отказоустойчивости и снижения задержек пользователей из разных регионов планируется геораспределённая архитектура:
- Используется два ЦОДа — в Москве (основной) и Новосибирске (резервный) с архитектурой типа **Active–Standin**:
	- В каждом регионе развёрнуты идентичные микросервисы, Redis, Elasticsearch и Kafka-кластер.
	- В Москве расположены мастер-реплики PostgreSQL и Kafka.
	- В Новосибирске доступны только операции чтения: поиск и просмотр объявлений.
- **PostgreSQL** работает в модели `global master + regional read replicas`, где записи выполняются в Москве, а Новосибирск обслуживает только чтение.
	- для записи из второго ЦОД pgPool выдаёт подключение к мастеру
- **Redis** используется локально в каждом регионе с fallback в базу данных при холодном кэше.
- **Kafka** кластер развёрнут в центральном ЦОД, сервисы из других регионов подключаются напрямую к EventBus. Это упростит топологию и предотвратит split-brain, но могут возникнуть проблемы с задержками и сетевой доступностью (тогда придётся рассматривать решение с развёртыванием второго кластера кафки на ЦОД в Новосибирске)
- **DNS (GeoDNS)** определяет ближайший регион, куда перенаправить пользователя.
- **Elasticsearch** - в каждом регионе развёрнут свой кластер. Синхронизация через события в Kafka. В каждом регионе работает свой search-indexer (микросервис, читающий kafka-топики и обновляющий локальный elastic)
- При отказе основного региона автоматически включается резервный с синхронизированными данными (RPO < 5 мин).
#### Стратегии кэширования
Используется Redis в каждом ЦОДе (Москва и Новосибирск) — локально для сервисов этого региона. Это обеспечивает низкие задержки и независимость при отказе одной зоны.
- Будем кэшировать популярные объявления в Redis. Так как они часто запрашиваются - данные в search-service прогреваются при старте приложения, а так же используем read-through кэш. 
	- Данные карточек объявлений загружаются в кэш при первом обращении
	- Динамические данные кэшируются по событиям AdViewed, AdUpdated
- В сервисе по работе с данными профиля используем write-through, чтобы данные быстро подгружались после логина. Инвалидация кэша происходит по событию UserProfileUpdated
- При работе с внешними API сервисов доставки используем долгое время жизни кэша (TTL 15-30 минут) и обновляем при получении запроса от внешней службы, так как тяжело каждый раз ходить на внешние API
- При холодном старте или сбое Redis — система работает в fallback-режиме с прямым чтением из БД или ES.
- Статические данные (медиа) в CDN кэшируем, например, для превью объявлений
### Обеспечение высокой доступности
- Используем два географически разделённых ЦОДа с балансировкой на DNS-уровне (GeoDNS).
- Все микросервисы реплицированы и могут быть автоматически перезапущены (k8s, автоскейлинг).
- Используются отказоустойчивые компоненты:
	- Kafka с несколькими брокерами и replication factor >1.
	- Redis в режиме кластера с Sentinel или Redis Cluster.
	- PostgreSQL с репликацией и failover-механизмом.
	- CDN для раздачи медиа по ближайшим узлам.
#### Сценарии отказов и реакции системы
1. **Отказ одного микросервиса (например, ad-service)**:
   - Перезапуск контейнера через orchestrator (k8s).
   - Временно обработка осуществляется другими репликами.

2. **Отказ брокера Kafka**:
   - Kafka использует репликацию. Продюсеры и консьюмеры автоматически переключаются на активные брокеры.

3. **Потеря соединения между ЦОДами**:
   - ЦОД Новосибирск продолжает обслуживать только операции чтения из кэша/реплики.
   - Записи буферизуются через Outbox и доставляются в Kafka после восстановления канала.

4. **Отказ PostgreSQL-мастера**:
   - Failover на реплику (manually или через pg_auto_failover).
   - Приложения автоматически меняют подключение через pgbouncer

5. **Недоступность Redis**:
   - Временное отключение кэширования, возврат к прямым запросам в БД.

6. **Отказ одного ЦОДа**:
   - DNS-система маршрутизирует весь трафик во второй ЦОД.
   - Критические сервисы перезапускаются из образов, данные догоняются после восстановления.
####  Рекомендации по высокой доступности
- Хранить состояния микросервисов минимально (stateless, session через JWT).
- Использовать readiness/liveness пробы в k8s.
- Применять circuit breaker и retry для вызовов внешних API.
- Хранить критичные данные (оплаты, заказы) с подтверждённой записью.
- Внедрить централизованную систему логирования (ELK/Loki) и алертов (Prometheus + AlertManager).
### Оптимизация производительности
Узкие места и решения:
- запросы к Postgres при высоком объёме данных
	- индексация по регионам, времени создания
	- кэширование популярных объявлений (описано выше)
- поиск объявлений при большом количестве фильтров и сложных запросах
	- GiST- или GIN-индексы по полям `tags`, `categories`, `text` для полнотекстового поиска.
	- индексы на поля фильтрации и сортировки.
- генерация страниц каталога и ленты
	- используем пагинацию (keyset)
	- применяем batch-запросы
- задержки от внешних API
	- TTL-кэш внешних API (доставка, валюта, гео-инфо) — от 10 до 30 минут