## Обоснование выбора технологий

### Реляционные базы данных (PostgreSQL)
Используется для хранения критичных и транзакционных данных:
- Пользователи, аккаунты, профили.
- Объявления (карточка как факт: владелец, цена, состояние).
- Заказы и оплаты (денежные операции, статусы).
- Справочники (категории, города, тарифы).
- Аудит действий пользователей.

**Почему именно PostgreSQL**:
- Поддержка транзакций и целостности данных (ACID).
- Гибкая система индексов, внешние ключи.
- Возможности партиционирования таблиц для масштабирования.
- Хорошо работает в мультизонной архитектуре.

### NoSQL базы данных

**Elasticsearch**:
- Для полнотекстового поиска и фильтрации объявлений.
- Быстрая выдача результатов и поддержка геопоиска.
- Репликация и шардирование встроены.

**ClickHouse**:
- Для аналитики и отчётности (просмотры, конверсии, метрики).
- Эффективное хранение и обработка больших объёмов событий.
- Поддержка материализованных представлений и партиционирования.

### Кэш (Redis)
- Быстрый доступ к часто используемым данным (сессии, профили, списки, счётчики).
- Поддержка кластерного режима, Sentinel, механизмов репликации.
- Возможность атомарных операций и Lua-скриптов для консистентности.

### CDN
- Раздача статических файлов и медиа (фото, видео, превью).
- Снижение нагрузки на бэкенд, ускорение загрузки.
- Геораспределённые узлы обеспечивают минимальную задержку.

## Стратегия консистентности и управления кэшем

### Что кэшируем
- Популярные страницы (результаты поиска, списки).
- Карточки объявлений.
- Профили пользователей.
- Справочники (категории, города).
- Результаты работы внешних API (доставка и т.п.).
- Счётчики просмотров и действий.

### Подходы
- **Cache-aside (read-through)** для объявлений, списков и справочников.
- **Write-through** для профилей: изменения сразу пишутся в БД и кэш.
- **Отложенная запись** для счётчиков (инкременты в Redis, периодический сброс в БД).

### Управление кэшем
- Инвалидация по событиям (UserProfileUpdated, AdUpdated).
- Версионирование пространств ключей для списков (например, search:{ver}:{hash}).
- Разброс TTL, чтобы избежать массового истечения ключей одновременно.
- Fallback: при недоступности Redis — прямое чтение из БД/ES.

### Консистентность
- Источник истины — PostgreSQL.
- Redis используется как ускоритель, данные там считаются временными.
- Все операции изменения фиксируются в БД и через Outbox публикуются в Kafka.
- Обработчики событий обновляют кэш и индекс поиска (ES).

## План масштабирования системы

### PostgreSQL
- В Москве: ведущий сервер и несколько реплик по зонам (синхронная и асинхронная).
- Партиционирование больших таблиц (orders, payments, audit).
- При росте нагрузки — горизонтальное шардирование по ключу (user_id или бизнес-домен).
- Регулярные бэкапы и WAL-архивирование → хранилище, доступное в Новосибирске.

### Elasticsearch
- Индекс объявлений разбит на несколько шардов (3–5).
- Реплики = 1–2 для отказоустойчивости.
- Политики ILM для «старых» индексов: перевод в тёплое хранилище или удаление.
- Снапшоты индексов в объектное хранилище.

### ClickHouse
- ReplicatedMergeTree по зонам в Москве.
- Партиционирование по времени.
- Возможность добавления новых шардов при росте нагрузки.
- TTL для сырых событий, агрегации через материализованные представления.

### Redis
- Кластерный режим с Sentinel.
- Возможность горизонтального масштабирования по шардам.
- Регулярные снапшоты (RDB/AOF) в хранилище.

### CDN
- Большие TTL + версионирование файлов (app.abcd1234.js).
- Ленивая загрузка изображений.
- Использование современных форматов (WebP/AVIF).
- При росте трафика — автоматическое масштабирование через сеть CDN.

## Итог

Предложенная архитектура объединяет:
- **Реляционное ядро (PostgreSQL)** для транзакционной целостности.
- **Поисковый индекс (Elasticsearch)** для быстрых запросов.
- **Аналитическое хранилище (ClickHouse)** для отчётности.
- **Кэш (Redis)** для ускорения операций чтения и снижения нагрузки на БД.
- **CDN** для раздачи статики и медиа.

Такая комбинация обеспечивает высокую производительность, масштабируемость и надёжность, при этом оптимизирует затраты за счёт разграничения «источника истины» и вспомогательных ускорителей.
